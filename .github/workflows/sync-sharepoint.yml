name: Sync SharePoint Excel

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Descarga directa con credenciales básicas (más simple que Graph)
      - name: Download Excel via direct URL
        shell: pwsh
        env:
          SP_URL: ${{ secrets.SHAREPOINT_URL }}
          SP_USER: ${{ secrets.SHAREPOINT_USERNAME }}
          SP_PASS: ${{ secrets.SHAREPOINT_PASSWORD }}
        run: |
          if (-not $env:SP_URL -or -not $env:SP_USER -or -not $env:SP_PASS) {
            Write-Error "Faltan secrets: SHAREPOINT_URL / SHAREPOINT_USERNAME / SHAREPOINT_PASSWORD"
          }

          $sec = ConvertTo-SecureString $env:SP_PASS -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($env:SP_USER, $sec)

          if (!(Test-Path data)) { New-Item -ItemType Directory -Path data | Out-Null }

          $outFile = "data/FinOps-Azure-Alertado.xlsx"
          Write-Host "Descargando: $($env:SP_URL)"
          Invoke-WebRequest -Uri $env:SP_URL -OutFile $outFile -Credential $cred -UseBasicParsing

          $bytes = [System.IO.File]::ReadAllBytes($outFile)
          if ($bytes.Length -lt 2 -or $bytes[0] -ne 0x50 -or $bytes[1] -ne 0x4b) {
            Write-Error "El archivo descargado no es XLSX (cabecera PK faltante)."
          }

          $status = @{
            exists = $true
            checked = [DateTime]::UtcNow.ToString("o")
            source = "SharePoint (basic auth)"
            message = "Sincronizado correctamente"
          }
          $status | ConvertTo-Json | Set-Content -Path data/status.json -Encoding UTF8

      - name: Commit and push if changed
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/status.json data/FinOps-Azure-Alertado.xlsx || true
          if ! git diff --cached --quiet; then
            git commit -m "Sync Excel from SharePoint (direct URL)"
            git push
          else
            echo "No changes to commit."
          fi
